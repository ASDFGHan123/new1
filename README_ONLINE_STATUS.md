# Online/Offline Status Tracking System - Complete Documentation

## ğŸ“‹ Table of Contents
1. [Overview](#overview)\n2. [Quick Start](#quick-start)\n3. [System Architecture](#system-architecture)\n4. [Components](#components)\n5. [Configuration](#configuration)\n6. [Testing](#testing)\n7. [Troubleshooting](#troubleshooting)\n8. [Documentation Files](#documentation-files)\n\n---\n\n## Overview\n\nA complete WhatsApp-style automatic online/offline tracking system for the OffChat Admin Dashboard.\n\n### Key Features\n- âœ… Automatic online status on login\n- âœ… Automatic offline status on logout\n- âœ… Heartbeat mechanism (every 30 seconds)\n- âœ… Automatic inactivity detection (2 minutes)\n- âœ… Real-time admin panel updates (every 10 seconds)\n- âœ… Celery task automation (every minute)\n- âœ… Database optimization with indexes\n- âœ… Production-ready implementation\n\n---\n\n## Quick Start\n\n### Prerequisites\n```bash\n# Check Python version\npython --version  # Should be 3.9+\n\n# Check Node version\nnode --version    # Should be 18+\n\n# Check Redis\nredis-cli ping    # Should return PONG\n```\n\n### Setup (5 minutes)\n\n```bash\n# 1. Install dependencies\npip install -r requirements-dev.txt\nnpm install\n\n# 2. Run migrations\npython manage.py migrate --settings=offchat_backend.settings.development\n\n# 3. Create superuser\npython manage.py createsuperuser --settings=offchat_backend.settings.development\n```\n\n### Run (4 terminals)\n\n```bash\n# Terminal 1: Redis\nredis-server\n\n# Terminal 2: Django\npython manage.py runserver --settings=offchat_backend.settings.development\n\n# Terminal 3: Celery\ncelery -A offchat_backend worker --beat -l info\n\n# Terminal 4: Frontend\nnpm run dev\n```\n\n### Verify\n\n1. Open http://localhost:5173\n2. Login with admin credentials\n3. Open DevTools (F12) â†’ Network tab\n4. Should see POST to `/api/users/heartbeat/` every 30 seconds\n5. Go to admin panel â†’ Users should show as \"online\"\n\n---\n\n## System Architecture\n\n### Data Flow Diagram\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                     USER LOGIN                              â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                     â”‚\n                     â–¼\n        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n        â”‚  LoginView.post()      â”‚\n        â”‚  user.set_online()     â”‚\n        â”‚  online_status='online'â”‚\n        â”‚  last_seen=now         â”‚\n        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                     â”‚\n        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n        â”‚  Frontend Stores Token â”‚\n        â”‚  Starts Heartbeat      â”‚\n        â”‚  Starts Auto-Refresh   â”‚\n        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                     â”‚\n        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n        â”‚  HEARTBEAT (every 30 seconds)                â”‚\n        â”‚  POST /api/users/heartbeat/                  â”‚\n        â”‚  Backend: update_last_seen()                 â”‚\n        â”‚  Result: User stays online                   â”‚\n        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                     â”‚\n        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n        â”‚  MIDDLEWARE (every request)                  â”‚\n        â”‚  Intercepts authenticated request            â”‚\n        â”‚  Backend: update_last_seen()                 â”‚\n        â”‚  Result: User stays online                   â”‚\n        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                     â”‚\n        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n        â”‚  AUTO-REFRESH (every 10 seconds)             â”‚\n        â”‚  GET /api/users/admin/users/                 â”‚\n        â”‚  Backend: returns fresh user data            â”‚\n        â”‚  Result: Admin panel shows current status    â”‚\n        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                     â”‚\n        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n        â”‚  INACTIVITY DETECTION (every 1 minute)       â”‚\n        â”‚  Celery task runs                            â”‚\n        â”‚  Check: last_seen < now - 2 minutes          â”‚\n        â”‚  Action: Mark inactive users offline         â”‚\n        â”‚  Result: User goes offline                   â”‚\n        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                     â”‚\n        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n        â”‚  USER LOGOUT                                 â”‚\n        â”‚  LogoutView.post()                           â”‚\n        â”‚  user.set_offline()                          â”‚\n        â”‚  online_status='offline'                     â”‚\n        â”‚  Intervals cleared                           â”‚\n        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n---\n\n## Components\n\n### 1. Database Layer\n**File**: `users/models.py`\n\n**Fields**:\n- `online_status` (CharField): 'online', 'away', 'offline'\n- `last_seen` (DateTimeField): Last activity timestamp\n\n**Methods**:\n- `set_online()`: Mark user online\n- `set_offline()`: Mark user offline\n- `set_away()`: Mark user away\n- `update_last_seen()`: Update timestamp\n- `is_online` property: Check if online\n\n### 2. Middleware Layer\n**File**: `users/middleware.py`\n\n**UserPresenceMiddleware**:\n- Runs on every authenticated request\n- Updates `online_status` to 'online'\n- Updates `last_seen` timestamp\n\n### 3. Authentication Layer\n**File**: `users/views/__init__.py`\n\n**LoginView**:\n- Calls `user.set_online()` on successful login\n- Sets online_status to 'online'\n\n**LogoutView**:\n- Calls `user.set_offline()` on logout\n- Sets online_status to 'offline'\n\n### 4. Heartbeat System\n**Frontend**: `src/App.tsx`\n- Sends POST to `/api/users/heartbeat/` every 30 seconds\n- Keeps user online during idle periods\n\n**Backend**: `users/views/user_management_views.py`\n- Endpoint: `POST /api/users/heartbeat/`\n- Updates `last_seen` timestamp\n- Ensures user is online\n\n### 5. Inactivity Detection\n**File**: `users/services/online_status_service.py`\n\n**mark_inactive_users_offline()**:\n- Marks users offline if `last_seen` > 2 minutes old\n- Configurable timeout\n- Efficient database query\n\n### 6. Celery Task\n**File**: `users/tasks.py`\n\n**check_and_mark_offline_users()**:\n- Runs every minute via Beat scheduler\n- Calls `mark_inactive_users_offline()`\n- Handles errors gracefully\n\n### 7. API Endpoints\n**File**: `users/urls.py`\n\n**Endpoints**:\n- `POST /api/users/heartbeat/` - Update heartbeat\n- `GET /api/users/admin/users/` - Get all users\n- `GET /api/users/admin/users/<id>/online-status/` - Get user status\n- `POST /api/users/admin/users/<id>/set-online-status/` - Set user status\n- `GET /api/users/admin/users/online/` - Get online users\n\n### 8. Frontend Auto-Refresh\n**File**: `src/App.tsx`\n\n**Auto-Refresh**:\n- Refreshes user list every 10 seconds\n- Calls `loadUsers()` function\n- Shows fresh status in admin panel\n\n---\n\n## Configuration\n\n### Inactivity Timeout\n**File**: `users/services/online_status_service.py`\n```python\nINACTIVITY_TIMEOUT_MINUTES = 2  # Change to desired minutes\n```\n\n### Heartbeat Interval\n**File**: `src/App.tsx`\n```typescript\nheartbeatIntervalRef.current = setInterval(sendHeartbeat, 30000);  // milliseconds\n```\n\n### Auto-Refresh Interval\n**File**: `src/App.tsx`\n```typescript\nrefreshIntervalRef.current = setInterval(loadUsers, 10000);  // milliseconds\n```\n\n### Celery Task Schedule\n**File**: `offchat_backend/celery.py`\n```python\napp.conf.beat_schedule = {\n    'check-offline-users': {\n        'task': 'users.tasks.check_and_mark_offline_users',\n        'schedule': crontab(minute='*/1'),  # Every minute\n    },\n}\n```\n\n---\n\n## Testing\n\n### Test 1: Login\n```bash\n1. Login with admin credentials\n2. Check database: SELECT online_status FROM users WHERE username='admin'\n3. Should return 'online'\n4. Check admin panel: User should show as \"online\"\n```\n\n### Test 2: Heartbeat\n```bash\n1. Stay logged in and idle\n2. Open DevTools Network tab\n3. Every 30 seconds, should see POST to /api/users/heartbeat/\n4. Check database: last_seen should update every 30 seconds\n```\n\n### Test 3: Inactivity\n```bash\n1. Close browser or disconnect\n2. Wait 2+ minutes\n3. Check Celery logs: Should see task execution\n4. Check database: online_status should be 'offline'\n```\n\n### Test 4: Admin Panel\n```bash\n1. Open admin panel\n2. Open DevTools Network tab\n3. Every 10 seconds, should see GET to /api/users/admin/users/\n4. User statuses should update automatically\n```\n\n### Test 5: Logout\n```bash\n1. Click logout button\n2. Check database: online_status should be 'offline'\n3. Check admin panel: User should show as \"offline\"\n```\n\n---\n\n## Troubleshooting\n\n### Issue: Users showing offline when they should be online\n\n**Checklist**:\n- [ ] Is heartbeat sending? (Check DevTools Network tab)\n- [ ] Is middleware running? (Check Django settings)\n- [ ] Is Celery running? (Check terminal output)\n- [ ] Is Redis running? (Check `redis-cli ping`)\n\n**Solution**:\n```bash\n# Restart all services\nredis-server\npython manage.py runserver --settings=offchat_backend.settings.development\ncelery -A offchat_backend worker --beat -l info\n```\n\n### Issue: Users not going offline after inactivity\n\n**Checklist**:\n- [ ] Is Celery worker running? (Look for \"celery@\" in terminal)\n- [ ] Is Beat scheduler running? (Look for \"Scheduler\" in logs)\n- [ ] Is Redis running? (Check Celery connection)\n\n**Solution**:\n```bash\n# Restart Celery with beat\ncelery -A offchat_backend worker --beat -l info\n```\n\n### Issue: Admin panel showing stale data\n\n**Checklist**:\n- [ ] Is auto-refresh working? (Check DevTools Network tab)\n- [ ] Is API returning fresh data? (Check response timestamps)\n- [ ] Is browser caching? (Check DevTools Cache)\n\n**Solution**:\n```bash\n# Hard refresh browser\nCtrl+Shift+R (Windows/Linux)\nCmd+Shift+R (Mac)\n```\n\n---\n\n## Documentation Files\n\n### ğŸ“„ ONLINE_STATUS_VERIFICATION.md\nComplete verification guide with:\n- Component checklist\n- Data flow explanation\n- Configuration details\n- Testing checklist\n- Troubleshooting guide\n\n### ğŸ“„ ONLINE_STATUS_QUICKSTART.md\nQuick start guide with:\n- Prerequisites\n- Setup instructions\n- Verification steps\n- Testing procedures\n- Configuration options\n\n### ğŸ“„ ONLINE_STATUS_IMPLEMENTATION_SUMMARY.md\nImplementation details with:\n- All components overview\n- Data flow diagram\n- Key features\n- Configuration options\n- Running instructions\n\n### ğŸ“„ ONLINE_STATUS_FINAL_CHECKLIST.md\nFinal verification checklist with:\n- Pre-flight checks\n- Component verification\n- Runtime verification\n- Database verification\n- Performance verification\n\n### ğŸ“„ FIXES_APPLIED.md\nAll fixes applied with:\n- Root cause analysis\n- Detailed fixes\n- Testing results\n- Performance impact\n- Configuration details\n\n---\n\n## Performance Metrics\n\n| Component | Frequency | Impact | Notes |\n|-----------|-----------|--------|-------|\n| Heartbeat | Every 30s | ~1KB POST | Minimal network impact |\n| Middleware | Every request | <1ms | Negligible performance impact |\n| Auto-refresh | Every 10s | ~5KB GET | Reasonable for admin panel |\n| Celery Task | Every 1 min | <1s | Efficient database query |\n| Database | Continuous | Minimal | Proper indexes on fields |\n\n---\n\n## Security Considerations\n\n- âœ… All endpoints require authentication\n- âœ… Admin endpoints require admin permissions\n- âœ… No sensitive data exposed\n- âœ… Tokens properly blacklisted on logout\n- âœ… Rate limiting can be added if needed\n\n---\n\n## Production Deployment\n\n### Requirements\n- Python 3.9+\n- Node.js 18+\n- PostgreSQL (not SQLite)\n- Redis (dedicated server)\n- Celery worker (separate process)\n- Beat scheduler (can be on same server)\n\n### Environment Variables\n```bash\nDEBUG=False\nSECRET_KEY=<your-secret-key>\nALLOWED_HOSTS=yourdomain.com\nDB_NAME=offchat_prod\nDB_USER=offchat_user\nDB_PASSWORD=<secure-password>\nDB_HOST=localhost\nDB_PORT=5432\nREDIS_URL=redis://localhost:6379/0\n```\n\n### Deployment Steps\n```bash\n# 1. Install production dependencies\npip install -r requirements.txt\n\n# 2. Build frontend\nnpm run build\n\n# 3. Run migrations\npython manage.py migrate --settings=offchat_backend.settings.production\n\n# 4. Collect static files\npython manage.py collectstatic --settings=offchat_backend.settings.production\n\n# 5. Start with gunicorn\ngunicorn offchat_backend.wsgi:application --settings=offchat_backend.settings.production\n\n# 6. Start Celery worker\ncelery -A offchat_backend worker --beat -l info\n```\n\n---\n\n## Support\n\nFor issues or questions:\n1. Check the relevant documentation file\n2. Review logs in backend and Celery terminals\n3. Check browser DevTools Network tab\n4. Verify all services are running\n\n---\n\n## Status\n\nâœ… **PRODUCTION READY**\n\nAll components implemented, tested, and documented.\n\n---\n\n## Summary\n\nThe online/offline status tracking system is fully implemented with:\n- âœ… Automatic online on login\n- âœ… Automatic offline on logout\n- âœ… Heartbeat every 30 seconds\n- âœ… Auto-refresh every 10 seconds\n- âœ… Inactivity detection after 2 minutes\n- âœ… Celery task every minute\n- âœ… Fresh data in admin panel\n- âœ… No stale data displayed\n- âœ… Production-ready implementation\n- âœ… Complete documentation\n\nThe system is ready for production deployment.\n